- pipeline: Set up Staging Server
  events:
  - type: PUSH
    refs:
    - refs/heads/main
  fail_on_prepare_env_warning: true
  actions:
  - action: build staging server
    type: DOCTL
    disabled: false
    integration: digitalocean
    execute_commands:
    - "doctl compute droplet create ps-staging --size s-1vcpu-1gb --image lemp-20-04 --region nyc1 --ssh-keys ${do_ssh_key} --project-id ${do_project_id} --format PublicIPv4 --enable-backups"
    shell: BASH
  - action: Install dependencies and clean up nginx
    type: DOCTL
    integration: digitalocean
    retry_interval: 15
    retry_count: 4
    execute_commands:
    - ln -sf /usr/share/zoneinfo/America/Phoenix /etc/localtime
    - DEBIAN_FRONTEND=noninteractive
    - rm -f /etc/nginx/sites-available/default
    - rm -f /etc/nginx/sites-available/digitalocean
    setup_commands:
      - "apt-get update && apt-get install -y git zip nodejs composer"
    shell: BASH
  - action: REPO - move files to server
    type: DIGITAL_OCEAN
    local_path: /
    remote_path: /var/www/html/precisionscience/
    login: root
    host: ps-staging
    env_key: secure!zo+eTWNM4pwAc/1buJ5q2w==.JYKADJdbZwhYeYYrpfVMjw==
    authentication_mode: ENV_KEY
    integration: digitalocean
    retry_interval: 15
    retry_count: 4
  - action: Composer and NPM install
    type: DOCTL
    integration: digitalocean
    execute_commands:
    - mkdir -p /var/www/html/precisionscience
    - cd /var/www/html/precisionscience/
    - composer install
    - cd /var/www/html/precisionscience/web/app/themes/ps2_theme
    - composer install
    - npm install
    - npm build
    shell: BASH
  - action: nginx config
    type: DOCTL
    integration: digitalocean
    execute_commands:
    - mv /var/www/pshosting/config/nginx/pshosting /etc/sites-available/pshosting
    - ln -s /etc/sites-available/pshosting /etc/sites-enabled/pshosting
    - systemctl restart nginx
    shell: BASH
